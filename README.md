
# Регламент ветвления и выпуска версий

## 1. Цели
- Обеспечить параллельную разработку и интеграцию функциональных задач.  
- Разделить окружения разработки (`dev`), тестирования (`release`) и промышленной эксплуатации (`main`).  
- Обеспечить возможность выборочного продвижения задач из `dev` в `release`.  
- Исключить накопление расхождений между ветками и нарушения структуры истории репозитория.  

## 2. Назначение веток
| Ветка | Назначение |
|--------|-------------|
| `main` | Основная стабильная ветка, соответствующая production-окружению. |
| `release` | Ветка предварительного тестирования (QA), формируется из отобранных задач, прошедших интеграцию. |
| `dev` | Интеграционная ветка для объединения завершённых фич и выполнения комплексного тестирования. |
| `feature/<TASK-ID>-<описание>` | Ветка для реализации отдельной задачи или изменения. Создаётся от `main`. |

## 3. Общий процесс разработки

### 3.1. Создание фичи
- Каждая новая задача разрабатывается в отдельной ветке:  
  ```bash
  git switch -c feature/TASK-123 origin/main
  ```
- Ветка создаётся **исключительно от `main`**, а не от `dev` или `release`.  

### 3.2. Интеграция в `dev`
- После завершения разработки создаётся Pull Request (PR) из `feature/*` в `dev`.  
- Для слияния используется **squash merge**, обеспечивающий единый коммит на задачу.  
- После слияния выполняется автоматический деплой на окружение разработки (`dev`).  

### 3.3. Формирование `release`
- В ветку `release` включаются **только отобранные** задачи посредством cherry-pick соответствующих сквош-коммитов из `dev`.  
  ```bash
  git checkout release && git pull
  git cherry-pick <sha-task-1> <sha-task-3>
  git push
  ```
- После каждого обновления `release` выполняется автоматический деплой на QA-окружение.

### 3.4. Подготовка релиза
- После успешного тестирования в `release` утверждённые изменения переносятся в `main`:
  - либо **слиянием всей ветки `release`** (если её состав согласован и проверен);
  - либо **через выборочный cherry-pick** одобренных коммитов (при необходимости избирательного включения задач).
- Затем создаётся тег релиза:
  ```bash
  git tag -a vYYYY.MM.DD -m "Release YYYY-MM-DD"
  git push --tags
  ```

## 4. Сценарий при отставании ветки `main`
Если `main` значительно отстаёт от `release`, необходимо выполнить синхронизацию.

### 4.1. Диагностика
```bash
git fetch origin
git log --oneline origin/main..origin/release
git cherry -v origin/main origin/release
```

### 4.2. Варианты синхронизации

#### Вариант A — Полное слияние `release` в `main`
```bash
git switch main
git pull
git merge --no-ff origin/release
git push
```

#### Вариант B — Избирательное включение изменений
```bash
git switch main
git pull
git cherry-pick <sha-task-1> <sha-task-3>
git push
```

## 5. Правила работы с ветками
1. Каждая задача реализуется в отдельной ветке `feature/*`, созданной от `main`.  
2. Слияние в `dev` осуществляется только с использованием squash merge.  
3. Продвижение задач в `release` выполняется через cherry-pick сквош-коммитов.  
4. Ветка `release` должна быть короткоживущей. После выпуска релиза создаётся новая ветка, например:  
   ```bash
   git switch -c release/2025-11-14 origin/main
   ```
5. Прямые коммиты в `release` и `main` запрещены.  
6. Force-push во все защищённые ветки (`main`, `release`, `dev`) запрещён.  
7. Все изменения, попавшие в `release`, должны быть доставлены в `main` в том же релизном цикле.  

## 6. Работа с хотфиксами
- Хотфиксы создаются от `main`:  
  ```bash
  git switch -c hotfix/TASK-999 origin/main
  ```
- После тестирования хотфикс вносится в `main` и, при необходимости, cherry-pick’ом в активный `release`.  

## 7. Автоматизация
Рекомендуется реализовать процессы через CI/CD:
- Автоматическое создание ветки `release/<date>` от `main` по метке `promote:release`.  
- Автоматическое выполнение cherry-pick отмеченных задач из `dev` в `release`.  
- Автоматическое открытие PR для переноса утверждённых изменений из `release/<date>` в `main`.  
- Автоматическая генерация тегов и changelog при каждом релизе.

## 8. Контроль качества
Перед слиянием Pull Request:
- Проверен успешный проход CI-пайплайна.  
- Проведён код-ревью минимум одним членом команды.  
- В описании PR указаны номера задач, описание изменений и наличие миграций или фичефлагов.  
- Для QA предоставлен список SHA коммитов, включаемых в релиз.  

## 9. Чек-лист перед выпуском
- [ ] Все задачи прошли тестирование в `release`.  
- [ ] Изменения перенесены в `main` (через merge или cherry-pick).  
- [ ] Создан и задокументирован тег релиза.  
- [ ] Обновлена ветка `release` (или создана новая от `main` для следующего цикла).  
- [ ] Обновлён changelog.  
